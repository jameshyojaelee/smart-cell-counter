name: iOS CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: macos-15
    env:
      GIT_TERMINAL_PROMPT: 0
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure GitHub auth for SPM
        run: |
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Install tooling
        run: |
          brew install xcodegen swiftlint swiftformat || true

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Show Xcode version
        run: xcodebuild -version

      - name: List available simulators (debug)
        run: xcrun simctl list devicetypes

      - name: SwiftLint
        run: |
          if command -v swiftlint >/dev/null 2>&1; then
            swiftlint --strict
          else
            echo "SwiftLint not installed; skipping"
          fi

      - name: SwiftFormat
        run: |
          if command -v swiftformat >/dev/null 2>&1; then
            swiftformat Sources Tests --lint --swiftversion 5.9
          else
            echo "swiftformat not installed; skipping"
          fi

      - name: Build, Test, and Collect Coverage
        run: |
          set -euo pipefail

          xcodebuild -project SmartCellCounter.xcodeproj -scheme SmartCellCounter -resolvePackageDependencies

          echo "Selecting available iOS Simulator..."
          DEV_NAMES=("iPhone 16 Pro" "iPhone 16" "iPhone 16 Pro Max" "iPhone SE (3rd generation)")
          DEST=""
          for NAME in "${DEV_NAMES[@]}"; do
            if xcrun simctl list devices available | grep -q "$NAME"; then
              DEST="platform=iOS Simulator,name=$NAME"
              echo "Using simulator: $NAME"
              break
            fi
          done
          if [ -z "$DEST" ]; then
            DEST="platform=iOS Simulator"
          fi

          xcodebuild -project SmartCellCounter.xcodeproj \
            -scheme SmartCellCounter \
            -destination "$DEST" \
            -derivedDataPath DerivedData \
            -destination-timeout 300 \
            -enableCodeCoverage YES \
            test

      - name: Prepare coverage report
        run: |
          set -euo pipefail
          RESULT_PATH=$(find DerivedData/Logs/Test -maxdepth 1 -name '*.xcresult' -print 2>/dev/null | head -n 1)
          if [ -z "$RESULT_PATH" ]; then
            echo "No xcresult bundle found; creating empty coverage report"
            echo "{}" > coverage.json
          else
            xcrun xccov view --report --json "$RESULT_PATH" > coverage.json
          fi

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage
          path: coverage.json
